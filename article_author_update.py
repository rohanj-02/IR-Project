from bs4 import BeautifulSoup
import requests
import json
import os
from tqdm import tqdm

IN_DIR = "./data/final"
OUT_DIR = "./data/author_update"

PROXIES = [ "194.233.73.103:443",
"176.119.134.197:23500",
"66.29.154.103:3128",
"194.5.193.183:80",
"173.230.152.250:80",
"43.224.10.48:6666",
"185.24.233.208:80",
"170.155.5.235:8080",
"80.48.119.28:8080",
"152.32.214.121:80",
"94.73.212.196:80",
"169.57.1.85:8123",
"66.29.154.105:3128",
"118.193.39.226:80",
"47.74.152.29:8888",
"118.193.35.175:80",
"103.73.194.2:80",
"128.199.214.87:3128",
"95.67.19.181:3128",
"107.151.182.247:80",
"185.147.35.43:80",
"103.177.45.10:80",
"103.177.45.11:80",
"103.97.200.52:80",
"103.177.45.7:80",
"211.72.89.27:80",
"151.106.18.126:1080",
"195.182.152.238:38178",
"117.54.114.103:80",
"207.244.242.103:9090",
"213.222.34.200:53281",
"117.54.114.101:80",
"85.25.198.22:5566",
"5.58.58.209:8080",
"176.236.232.66:9090",
"62.176.12.111:8080",
"88.255.101.236:8080",
"193.233.229.166:8085",
"23.108.75.76:8118",
"108.177.248.110:8118",
"23.81.127.189:8118",
"23.108.79.4:8118",
"23.108.78.134:8118",
"23.108.75.189:8118",
"193.233.138.104:8085",
"23.108.79.25:8118",
"23.105.86.49:8118",
"108.177.248.133:8118",
"23.105.86.118:8118",
"23.108.42.202:8118",
"23.108.42.219:8118",
"23.108.42.187:8118",
"23.108.43.45:8118",
"23.108.75.238:8118",
"23.108.75.88:8118",
"23.108.75.41:8118",
"23.108.43.231:8118",
"193.233.229.141:8085",
"193.56.64.244:8085",
"23.108.78.163:8118",
"23.108.43.102:8118",
"23.108.64.114:8118",
"193.233.137.237:8085",
"23.108.43.112:8118",
"23.108.42.39:8118",
"23.108.42.246:8118",
"212.119.41.23:8085",
"103.144.21.37:8080",
"204.199.67.174:999",
"45.182.240.73:3128",
"190.152.182.150:55443",
"187.217.54.84:80",
"202.69.45.22:8080",
"188.138.106.93:5566",
"176.235.131.228:9090",
"103.109.96.69:8080",
"23.108.43.155:8118",
"212.119.40.85:8085",
"23.108.64.118:8118",
"108.177.248.34:8118",
"108.177.248.6:8118",
"23.108.64.93:8118",
"23.108.78.162:8118",
"43.241.29.201:8080",
"222.124.193.113:8080",
"41.180.106.6:8080",
"103.53.78.98:8080",
"177.190.80.226:8080",
"151.106.13.218:1080",
"154.49.216.33:3128",
"195.94.146.76:43075",
"85.25.226.133:5566",
"103.130.70.209:83",
"179.61.229.165:999",
"43.249.224.174:84",
"190.248.153.162:8080",
"65.20.191.201:41890",
"80.249.135.5:8080",
"14.102.13.161:8080",
"190.2.209.62:999",
"118.193.34.17:80",
"37.224.60.172:8080",
"188.138.89.50:5566",
"170.83.60.18:55443",
"118.193.34.51:80",
"151.106.17.124:1080",
"88.255.101.235:8080",
"145.40.73.107:80",
"191.97.19.93:999",
"180.250.102.194:8080",
"38.10.246.140:9991",
"118.193.40.245:80",
"20.47.108.204:8888",
"43.255.113.232:8082",
"46.4.168.62:3128",
"194.143.251.152:41258",
"162.144.116.103:80",
"5.160.101.163:3128",
"125.163.160.41:8080",
"187.111.176.121:8080",
"51.83.231.86:3128",
"51.83.241.108:3128",
"77.242.1.101:41890",
"43.243.140.194:8080",
"51.75.35.222:3128",
"51.83.231.23:3128",
"62.75.229.167:5566",
"85.25.242.142:5566",
"194.233.69.41:443",
"85.25.117.171:5566",
"181.129.183.19:53281",
"189.63.232.244:3128",
"103.177.146.1:30001",
"88.119.195.35:8080",
"110.74.199.16:63141",
"45.230.169.129:999",
"178.159.40.19:8080",
"186.3.9.218:999",
"202.169.252.238:8181",
"36.66.171.243:8080",
"190.110.99.98:999",
"183.89.114.36:8080",
"41.205.24.217:8080",
"181.49.217.254:8080",
"170.239.255.2:55443",
"179.43.94.238:999",
"188.138.106.158:5566",
"192.248.190.154:8001",
"58.27.59.249:80",
"45.80.149.37:23456",
"103.138.41.132:8080",
"1.186.245.226:1111",
"41.75.85.22:8080",
"117.121.204.9:32000",
"198.244.138.126:3128",
"45.80.149.38:23456",
"156.193.89.139:8080",
"45.189.58.66:9090",
"195.140.226.244:8080",
"36.92.85.66:8080",
"190.109.16.145:999",
"202.153.233.228:8080",
"103.17.246.150:8080",
"103.78.75.91:8080",
"23.94.222.241:3128",
"23.94.237.214:3128",
"23.94.230.91:3128",
"23.94.180.93:3128",
"23.94.237.166:3128",
"23.94.213.174:3128",
"23.94.242.40:3128",
"197.245.230.122:41026",
"181.13.3.156:999",
"51.83.230.93:3128",
"51.38.155.117:3128",
"54.38.141.157:3128",
"51.83.231.22:3128",
"54.38.51.134:3128",
"54.38.141.158:3128",
"54.38.141.156:3128",
"51.83.231.20:3128",
"51.83.230.121:3128",
"51.83.155.91:3128",
"54.38.51.128:3128",
"103.104.183.26:84",
"5.180.130.91:80",
"43.224.10.42:6666",
"119.235.25.66:8010",
"179.106.86.3:8080",
"188.133.138.197:8080",
"45.7.132.83:999",
"103.169.1.25:8080",
"165.16.27.4:1981",
"177.19.131.82:3130",
"179.1.129.94:999",
"149.28.229.95:80",
"36.67.27.153:8080",
"177.47.181.142:8080",
"85.62.10.83:8080",
"185.82.98.43:9091",
"113.161.70.165:41890",
"45.7.135.236:999",
"212.112.113.178:3128",
"23.94.242.34:3128",
"23.95.49.249:3128",
"23.94.73.80:3128",
"23.94.242.4:3128",
"23.94.213.180:3128",
"23.94.238.191:3128",
"23.94.180.15:3128",
"23.94.23.89:3128",
"23.94.222.247:3128",
"23.94.180.69:3128",
"23.94.242.76:3128",
"23.94.23.77:3128",
"23.94.213.198:3128",
"23.94.59.19:3128",
"23.95.49.159:3128",
"23.94.59.109:3128",
"23.95.49.153:3128",
"23.94.227.242:3128",
"23.94.230.7:3128",
"23.95.63.86:3128",
"23.94.237.184:3128",
"23.94.237.136:3128",
"23.94.180.99:3128",
"23.95.201.30:3128",
"23.94.73.110:3128",
"23.94.238.155:3128",
"23.94.238.131:3128",
"23.95.190.17:3128",
"23.94.242.118:3128",
"23.95.69.239:3128",
"23.94.213.144:3128",
"23.94.73.56:3128",
"23.95.49.207:3128",
"23.94.230.31:3128",
"23.95.183.124:3128",
"23.95.63.20:3128",
"23.95.63.2:3128",
"23.94.213.210:3128",
"23.95.69.185:3128",
"23.95.190.119:3128",
"23.94.59.126:3128",
"23.95.16.30:3128",
"23.94.73.86:3128",
"23.94.73.92:3128",
"23.95.49.237:3128",
"23.95.183.4:3128",
"23.95.49.189:3128",
"23.94.238.179:3128",
"23.94.180.45:3128",
"23.95.201.42:3128",
"23.94.230.79:3128",
"23.94.222.187:3128",
"23.94.237.226:3128",
"23.94.230.25:3128",
"23.95.69.155:3128",
"23.94.230.61:3128",
"23.94.213.132:3128",
"23.94.227.248:3128",
"23.94.227.212:3128",
"23.94.230.109:3128",
"23.95.16.90:3128",
"23.95.190.47:3128",
"23.94.73.2:3128",
"23.94.23.101:3128",
"23.95.63.26:3128",
"23.94.247.235:3128",
"23.95.190.5:3128",
"23.95.201.48:3128",
"23.95.16.114:3128",
"23.95.69.173:3128",
"23.94.238.251:3128",
"23.94.180.117:3128",
"23.95.49.135:3128",
"23.94.242.58:3128",
"23.94.222.199:3128",
"23.94.73.104:3128",
"23.95.16.24:3128",
"23.95.16.60:3128",
"23.94.238.215:3128",
"23.94.222.139:3128",
"23.94.237.172:3128",
"23.95.69.179:3128",
"23.95.49.231:3128",
"23.95.63.44:3128",
"23.95.49.165:3128",
"23.94.230.85:3128",
"23.94.238.143:3128",
"23.94.237.148:3128",
"23.95.16.48:3128",
"23.94.180.105:3128",
"23.94.238.137:3128",
"23.94.23.107:3128",
"183.88.219.206:41564",
"203.82.42.38:1337",
"23.105.86.24:8118",
"23.95.201.56:3128",
"23.105.71.203:8118"
]

for doc_id in os.listdir(IN_DIR):
    if os.path.exists(f"{OUT_DIR}/{doc_id}"):
        print("Exists")
        continue
    doc = json.load(open(f"{IN_DIR}/{doc_id}", "r"))
    new_articles = []
    i = 0
    for idx in tqdm(range(len(doc['articles']))):
        article = doc['articles'][idx]
    # for article in doc["articles"]:
        meta = {}
        try:
            req = requests.get(article["link"], proxies = {
                "https": f'http://{PROXIES[i]}'
            })
            soup = BeautifulSoup(req.content, "lxml")
            table = soup.find(id="gsc_oci_table")
            while table is None:
                req = requests.get(article["link"], proxies = {
                    "https": f'http://{PROXIES[i]}'
                 })
                soup = BeautifulSoup(req.content, "lxml")
                table = soup.find(id="gsc_oci_table")
                i += 1
                
            fields = table.find_all(class_="gs_scl")
            for field in fields:
                key = field.find(class_="gsc_oci_field").text
                value = field.find(class_= "gsc_oci_value").text
                meta[key] = value
            TO_DELETE = ["Total citations", "Scholar articles", "Description"]
            for key in TO_DELETE:
                if key in meta:
                    del meta[key]
        except Exception as e: 
            print(e)
            print(article['link'])
        print(meta)
        article["info"] = meta
        new_articles.append(article)
    doc["articles"] = new_articles
    with open(f"{OUT_DIR}/{doc_id}", "w") as outfile:
        json.dump(doc, outfile, indent=4)

    break
